/**
 * PoC Schritt 1: Anzeige eines extern konvertierten JPGs auf dem OLED.
 * 
 * -- Das Ziel --
 * Validieren, dass der Konvertierungsprozess mit einem XBM-Tool funktioniert und das Ergebnis korrekt auf dem 
 * Display angezeigt werden kann.
 * 
 * -- Der Code --
 * Ich habe den Demo-Sketch für das OLED-Display genommen und alles bis auf das absolut Notwendigste entfernt. 
 *
 * -- Das Test-Bitmap --
 * Ich habe mein Portrait auf 128x64 Pixel skaliert (siehe `docs/assets/frank_128x64.jpg`), mit dem Tool 
 * "Online Image Converter to XBM" (https://www.online-utility.org/image/convert/to/XBM) in ein monochromes 
 * XBM-Bitmap umgewandelt und als C-Array exportiert. Danach habe ich drei kleine Verbesserungen vorgenommen:
 * 1. Ich habe die automatisch generierten Namen (`1762397827716_...`) in `portrait_...` umbenannt. 
 *    Das ist lesbarer und vermeidet potenzielle Compiler-Fehler, da Bezeichner in C++ nicht 
 *    mit einer Ziffer beginnen sollten.
 * 2. Ich habe `static char` in `static const unsigned char` geändert. Das ist der korrekte Datentyp  
 *    für rohe Bytedaten und `const`, weil sich die Daten nicht ändern.
 * 3. Ich habe das `U8X8_PROGMEM`-Makro hinzugefügt. Das ist eine gute Praxis, die der U8g2-Bibliothek 
 *    signalisiert, dass diese großen Daten im Flash-Speicher bleiben sollen und nicht den RAM des 
 *    Mikrocontrollers belegen.
 */

#include <Arduino.h>
#include <U8g2lib.h>

#ifdef U8X8_HAVE_HW_SPI
#include <SPI.h>
#endif
#ifdef U8X8_HAVE_HW_I2C
#include <Wire.h>
#endif

// --- Display-Initialisierung ---
// Ich verwende die bekannte Konfiguration für das SH1106 I2C Display.
U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE);

// --- Das Test-Bitmap  im XBM-Format (konvertiert aus dem auf 128x64 skalierten JPG) ---
// XBM (X BitMap) ist ein Standard-C-Format, um monochrome Bilder zu speichern.
// Jedes Byte repräsentiert 8 horizontale Pixel. Die Bits werden "rückwärts" gelesen,
// d.h. das niedrigstwertige Bit (LSB) ist das linkeste Pixel.
#define portrait_width 128
#define portrait_height 64
static const unsigned char portrait_bits[] U8X8_PROGMEM = {
  0x00, 0x00, 0x00, 0xFE, 0xFF, 0x3B, 0xEE, 0x63, 0x4B, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x97, 0x5E, 0x0A, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xDF, 
  0xFD, 0x6B, 0xA7, 0x99, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x80, 0x7F, 0xF3, 0xBC, 0x5B, 0x64, 0x01, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x5F, 0xFD, 0xF5, 0x9F, 0xAA, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 
  0xA6, 0xBB, 0x62, 0x56, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xC0, 0xBF, 0xFE, 0xBD, 0xAB, 0xAF, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x7F, 0x95, 0x8B, 0xDE, 0x6B, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x7F, 
  0xAD, 0x87, 0xB7, 0xBF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xE0, 0x7F, 0xC9, 0x76, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFF, 0x5E, 0xEB, 0xFF, 0x7F, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFF, 
  0xA3, 0xF5, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xE0, 0xF7, 0x3E, 0xF7, 0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xDF, 0xA9, 0xFC, 0xFF, 0xA6, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFF, 
  0x5B, 0xFD, 0xBF, 0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xD0, 0xB7, 0x9D, 0xFE, 0x7F, 0x08, 0x00, 0x00, 0x00, 0x00, 
  0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xDF, 0xD5, 0xFF, 0x6F, 0x08, 
  0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 
  0xFD, 0xFF, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xF8, 0xFF, 0xFE, 0xFF, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xCF, 0xFD, 0xFF, 0x59, 0x01, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xBF, 
  0xFF, 0xFF, 0x2B, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0x17, 0x00, 0x00, 0x40, 0x00, 0x00, 
  0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0x56, 0x00, 
  0x00, 0x40, 0x0A, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 
  0xFF, 0xFF, 0x2F, 0x00, 0x00, 0xAC, 0x00, 0x80, 0x04, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xF0, 0xFF, 0xFF, 0xFF, 0x17, 0x00, 0xA0, 0x3A, 0x09, 0xC0, 
  0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFF, 0xFF, 0xFF, 0x6F, 0x02, 
  0x00, 0x41, 0x10, 0xC0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0xFF, 
  0xFF, 0xFF, 0x1F, 0x00, 0x40, 0x61, 0x45, 0xE1, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x40, 0xFF, 0xFF, 0xFF, 0x3F, 0x00, 0x10, 0x00, 0x3C, 0x80, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xFE, 0xFF, 0xFF, 0x1F, 0x00, 
  0x15, 0x90, 0xF7, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xFF, 
  0xFF, 0xFF, 0x6F, 0x18, 0x08, 0xE0, 0x6F, 0x01, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x2F, 0x00, 0x02, 0xF0, 0x5F, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0x9F, 0x42, 
  0x01, 0xFE, 0x01, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 
  0xFF, 0xFF, 0x0F, 0x44, 0x01, 0x19, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xE8, 0xFF, 0xFF, 0x6F, 0x00, 0xC2, 0x3F, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x0F, 0x00, 
  0x62, 0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 
  0xFF, 0xFF, 0x1F, 0xC4, 0x64, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xE0, 0xFF, 0xFF, 0x9F, 0x08, 0xDB, 0x81, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xFB, 0xFF, 0x1F, 0x00, 
  0x00, 0x08, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 
  0xC1, 0xFF, 0x0F, 0x80, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xE0, 0x84, 0xFF, 0x3F, 0x01, 0x40, 0x90, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x2E, 0xFF, 0x1F, 0x02, 
  0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 
  0xC8, 0xFF, 0xBF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x80, 0x80, 0xFC, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x09, 0xF2, 0x2F, 0x08, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x01, 0xE7, 0x5F, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x84, 0x3F, 0x25, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x08, 0x5F, 0x00, 
  0x00, 0x00, 0x00, 0xA0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x04, 0x08, 0x1C, 0xA5, 0x00, 0x00, 0x00, 0xF2, 0x05, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x25, 0x0A, 0x01, 0x00, 0x00, 0x28, 
  0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x40, 0xA0, 
  0x00, 0x00, 0x00, 0xA0, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x10, 0x20, 0x00, 0x01, 0x06, 0x00, 0x00, 0x80, 0x06, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x15, 0x68, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0xA1, 
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x40, 0x01, 0x8A, 0x00, 0x19, 0x00, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x22, 0x60, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 
  0x80, 0x01, 0x04, 0x40, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x02, 0x40, 0x00, 0x11, 0x00, 0x20, 0xB9, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x28, 0x96, 0x04, 0x04, 0xEC, 0x04, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x82, 
  0x84, 0x45, 0x06, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0xF8, 0xD2, 0x20, 0x22, 0x10, 0x00, 0x92, 0x02, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x27, 0x22, 0x90, 0x20, 0x01, 0xA0, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x5F, 0x44, 
  0x09, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x48, 0x3C, 0x41, 0x49, 0x22, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0xB8, 0xE1, 0x96, 0x14, 0x88, 0x04, 0x00, 
  0x00, 0x00, 0x00, 0x00, 
};

void setup() {
    Serial.begin(115200);
    Serial.println("JpgToBmp - PoC Schritt 1: Konvertiertes JPG anzeigen");

    // Display initialisieren
    u8g2.begin();
    
    // Puffer löschen, bevor wir zeichnen
    u8g2.clearBuffer();

    // Das XBM-Format verwendet '1' für schwarze Pixel. U8g2 zeichnet '1' standardmäßig als weiße Pixel.
    // Um das zu korrigieren, erstellen wir zuerst eine weiße Leinwand und "stanzen" dann die schwarzen Pixel aus.
    u8g2.setDrawColor(1);        // 1. Zeichenfarbe auf weiß (Pixel AN) setzen.
    u8g2.drawBox(0, 0, 128, 64); // 2. Eine gefüllte Box über den gesamten Bildschirm zeichnen, um den Hintergrund weiß zu machen.
    u8g2.setDrawColor(0);        // 3. Zeichenfarbe auf schwarz (Pixel AUS) setzen. Jede '1' in den Daten "löscht" nun einen Pixel und macht ihn schwarz.

    // --- Der Kern dieses Tests ---
    // Zeichne das konvertierte Portrait in den Puffer.
    // Da das Bild bereits 128x64 Pixel groß ist, zeichnen ich es an der Ecke (0,0).
    u8g2.drawXBMP(0, 0, portrait_width, portrait_height, portrait_bits);
    
    // Den Puffer-Inhalt an das Display senden, um ihn sichtbar zu machen
    u8g2.sendBuffer();

    Serial.println("Konvertiertes Portrait sollte jetzt auf dem Display sichtbar sein.");
}

void loop() {
    // Nichts zu tun hier, das Bild wird einmalig im setup() angezeigt.
    delay(1000);
}